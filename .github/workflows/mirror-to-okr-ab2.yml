name: Mirror docokr to Lovable repo

on:
  push:
    branches: [main]

jobs:
  mirror:
    runs-on: ubuntu-latest
    env:
      MIRROR_TOKEN_EFFECTIVE: ${{ secrets.MIRROR_TOKEN != '' && secrets.MIRROR_TOKEN || secrets.LOVABLE_MIRROR_TOKEN }}
    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push to Lovable repo
        run: |
          set -e
          git config user.name "docokr-mirror-bot"
          git config user.email "bot@users.noreply.github.com"

          if [ -z "${MIRROR_TOKEN_EFFECTIVE}" ]; then
            echo "Erro: secret MIRROR_TOKEN (ou LOVABLE_MIRROR_TOKEN) não configurado." >&2
            exit 1
          fi

          TARGETS=(
            "https://x-access-token:${MIRROR_TOKEN_EFFECTIVE}@github.com/docdanielmarques/okr-ab2.git"
            "https://x-access-token:${MIRROR_TOKEN_EFFECTIVE}@github.com/docdanielmarques/okr-ab2l.git"
          )

          success=0
          for target in "${TARGETS[@]}"; do
            echo "Tentando mirror para: ${target#*github.com/}"
            if git ls-remote "$target" >/dev/null 2>&1; then
              git remote remove lovable >/dev/null 2>&1 || true
              git remote add lovable "$target"
              git push --force lovable main:main
              success=1
              break
            fi
          done

          if [ "$success" -ne 1 ]; then
            echo "Falha: nenhum repositório destino respondeu. Verifique nome do repo e permissão do token." >&2
            exit 1
          fi
